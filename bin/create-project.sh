#!/usr/bin/env bash


# check required env variables before proceeding
: "${TF_VAR_billing_account:?ERROR: Env variable TF_VAR_billing_account not set !!!}"
: "${TF_ADMIN:?ERROR: Env variable TF_ADMIN not set !!!}"
: "${TF_CREDS:?ERROR: Env variable TF_CREDS not set !!!}"

# setup admin project
gcloud projects create ${TF_ADMIN} \
  --set-as-default

gcloud beta billing projects link ${TF_ADMIN} \
  --billing-account ${TF_VAR_billing_account}

gcloud iam service-accounts create terraform \
  --display-name "Terraform admin account"


gcloud iam service-accounts keys create ${TF_CREDS} \
  --iam-account terraform@${TF_ADMIN}.iam.gserviceaccount.com


gcloud projects add-iam-policy-binding ${TF_ADMIN} \
  --member serviceAccount:terraform@${TF_ADMIN}.iam.gserviceaccount.com \
  --role roles/viewer

gcloud projects add-iam-policy-binding ${TF_ADMIN} \
  --member serviceAccount:terraform@${TF_ADMIN}.iam.gserviceaccount.com \
  --role roles/storage.admin

gcloud projects add-iam-policy-binding ${TF_ADMIN} \
  --member serviceAccount:terraform@${TF_ADMIN}.iam.gserviceaccount.com \
  --role roles/editor

gcloud projects create ${TF_VAR_project_name}
gcloud beta billing projects link ${TF_VAR_project_name} \
  --billing-account ${TF_VAR_billing_account}
gcloud projects add-iam-policy-binding ${TF_VAR_project_name} \
  --member serviceAccount:terraform@${TF_ADMIN}.iam.gserviceaccount.com \
  --role roles/editor

gcloud projects add-iam-policy-binding ${TF_VAR_project_name} \
--member serviceAccount:terraform@${TF_ADMIN}.iam.gserviceaccount.com \
--role roles/storage.admin

##terraform setup for storing state and conf credentials
gsutil mb -p ${TF_ADMIN} -l ${TF_VAR_location} gs://${TF_ADMIN}

cat > config.tf << EOF
terraform {
  backend "gcs" {
     bucket  = "${TF_ADMIN}"
     prefix  = "terraform/state"
  }
  required_providers {
    google = {
      version = ">= 3.50"
      source  = "hashicorp/google"
  }

  google-beta = {
      version = ">= 3.50"
      source  = "hashicorp/google"
    }
  }
}
EOF

cat > env/dev.tfvars << EOF
### automatically generated by bin/create-project.sh script - do not change manually!
project_name = "${TF_VAR_project_name}"
location = "${TF_VAR_location}"
machine_type = "${TF_VAR_machine_type}"
EOF

gsutil versioning set on gs://${TF_ADMIN}

#enablple GCP API
for project in ${TF_VAR_project_name} ${TF_ADMIN};
do
  gcloud services --project $project enable iam.googleapis.com
  gcloud services --project $project enable container.googleapis.com
  gcloud services --project $project enable cloudresourcemanager.googleapis.com
done


gcloud services --project ${TF_VAR_project_name} list
gcloud projects add-iam-policy-binding ${TF_VAR_project_name}  \
   --member serviceAccount:terraform@${TF_ADMIN}.iam.gserviceaccount.com \
  --role=roles/container.admin